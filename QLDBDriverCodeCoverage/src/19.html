<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Repos\amazon-qldb-driver-dotnet\Amazon.QLDB.Driver\result\Result.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

namespace Amazon.QLDB.Driver
{
    using System;
    using System.Collections;
    using System.Collections.Generic;
    using Amazon.IonDotnet.Tree;
    using Amazon.QLDBSession.Model;

    /// &lt;summary&gt;
    /// Result implementation which streams data from QLDB, discarding chunks as they are read.
    ///
    /// Note that due to the fact that a result can only be retrieved from QLDB once, the Result may only be iterated
    /// over once. Attempts to do so multiple times will result in an exception.
    ///
    /// This implementation should be used by default to avoid excess memory consumption and to improve performance.
    /// &lt;/summary&gt;
    internal class Result : IResult
    {
        private readonly IonEnumerator ionEnumerator;
        private bool isRetrieved = false;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;Result&quot;/&gt; class.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;session&quot;&gt;The parent session that represents the communication channel to QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;txnId&quot;&gt;The ID of the parent transaction.&lt;/param&gt;
        /// &lt;param name=&quot;statementResult&quot;&gt;The result of the statement execution.&lt;/param&gt;
        internal Result(Session session, string txnId, ExecuteStatementResult statementResult)
        {
            this.ionEnumerator = new IonEnumerator(session, txnId, statementResult);
        }

        /// &lt;inheritdoc/&gt;
        public IEnumerator&lt;IIonValue&gt; GetEnumerator()
        {
            if (this.isRetrieved)
            {
                throw new InvalidOperationException();
            }

            this.isRetrieved = true;
            return this.ionEnumerator;
        }

        /// &lt;inheritdoc/&gt;
        IEnumerator IEnumerable.GetEnumerator()
        {
            return this.GetEnumerator();
        }

        /// &lt;summary&gt;
        /// Gets the current query statistics for the number of read IO requests. The statistics are stateful.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;The current IOUsage statistics.&lt;/returns&gt;
        public IOUsage? GetConsumedIOs()
        {
            return this.ionEnumerator.GetConsumedIOs();
        }

        /// &lt;summary&gt;
        /// Gets the current query statistics for server-side processing time. The statistics are stateful.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;The current TimingInformation statistics.&lt;/returns&gt;
        public TimingInformation? GetTimingInformation()
        {
            return this.ionEnumerator.GetTimingInformation();
        }

        /// &lt;summary&gt;
        /// Object which allows for iteration over the individual Ion values that make up the whole result of a statement
        /// execution against QLDB.
        /// &lt;/summary&gt;
        private class IonEnumerator : BaseIonEnumerator, IEnumerator&lt;IIonValue&gt;
        {
            /// &lt;summary&gt;
            /// Initializes a new instance of the &lt;see cref=&quot;IonEnumerator&quot;/&gt; class.
            /// &lt;/summary&gt;
            ///
            /// &lt;param name=&quot;session&quot;&gt;The parent session that represents the communication channel to QLDB.&lt;/param&gt;
            /// &lt;param name=&quot;txnId&quot;&gt;The unique ID of the transaction.&lt;/param&gt;
            /// &lt;param name=&quot;statementResult&quot;&gt;The result of the statement execution.&lt;/param&gt;
            internal IonEnumerator(Session session, string txnId, ExecuteStatementResult statementResult)
                : base(session, txnId, statementResult)
            {
            }

            object IEnumerator.Current =&gt; this.Current;

            /// &lt;summary&gt;
            /// Dispose the enumerator. No-op.
            /// &lt;/summary&gt;
            public void Dispose()
            {
                return;
            }

            /// &lt;summary&gt;
            /// Reset. Not supported.
            /// &lt;/summary&gt;
            public void Reset()
            {
                throw new NotSupportedException();
            }

            /// &lt;summary&gt;
            /// Advance the enumerator to the next value within the page.
            /// &lt;/summary&gt;
            ///
            /// &lt;returns&gt;True if there is another page token.&lt;/returns&gt;
            public bool MoveNext()
            {
                if (this.currentEnumerator.MoveNext())
                {
                    return true;
                }
                else if (this.nextPageToken == null)
                {
                    return false;
                }

                this.FetchPage();
                return this.MoveNext();
            }

            /// &lt;summary&gt;
            /// Fetch the next page from the session.
            /// &lt;/summary&gt;
            private void FetchPage()
            {
                FetchPageResult pageResult = this.session.FetchPage(this.txnId, this.nextPageToken);
                this.currentEnumerator = pageResult.Page.Values.GetEnumerator();
                this.nextPageToken = pageResult.Page.NextPageToken;
                this.UpdateMetrics(pageResult);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,42,1],[42,9,42,95,1],[43,9,43,10,1],[44,13,44,85,1],[45,9,45,10,1],[49,9,49,10,1],[50,13,50,34,1],[51,13,51,14,1],[52,17,52,55,1],[55,13,55,37,1],[56,13,56,39,1],[57,9,57,10,1],[61,9,61,10,0],[62,13,62,41,0],[63,9,63,10,0],[71,9,71,10,1],[72,13,72,56,1],[73,9,73,10,1],[81,9,81,10,1],[82,13,82,62,1],[83,9,83,10,1],[99,19,99,56,1],[100,13,100,14,1],[101,13,101,14,1],[103,43,103,55,0],[109,13,109,14,1],[110,17,110,24,1],[111,13,111,14,1],[117,13,117,14,1],[118,17,118,51,1],[127,13,127,14,1],[128,17,128,55,1],[129,17,129,18,1],[130,21,130,33,1],[132,22,132,53,1],[133,17,133,18,1],[134,21,134,34,1],[137,17,137,34,1],[138,17,138,40,1],[139,13,139,14,1],[145,13,145,14,1],[146,17,146,101,1],[147,17,147,81,1],[148,17,148,68,1],[149,17,149,48,1],[150,13,150,14,1]]);
    </script>
  </body>
</html>