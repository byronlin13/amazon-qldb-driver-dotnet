<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Repos\amazon-qldb-driver-dotnet\Amazon.QLDB.Driver\result\BaseIonEnumerator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

namespace Amazon.QLDB.Driver
{
    using System;
    using System.Collections.Generic;
    using Amazon.IonDotnet.Builders;
    using Amazon.IonDotnet.Tree;
    using Amazon.QLDBSession.Model;

    /// &lt;summary&gt;
    /// Abstract class for an object which allows for iteration over the individual Ion values that make up the whole result of a statement
    /// execution against QLDB.
    /// &lt;/summary&gt;
    internal abstract class BaseIonEnumerator
    {
        private protected readonly Session session;
        private protected readonly string txnId;
        private protected IEnumerator&lt;ValueHolder&gt; currentEnumerator;
        private protected string nextPageToken;
        private protected long? readIOs = null;
        private protected long? writeIOs = null;
        private protected long? processingTimeMilliseconds = null;

        private static readonly IonLoader IonLoader = IonLoader.Default;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;BaseIonEnumerator&quot;/&gt; class.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;session&quot;&gt;The parent session that represents the communication channel to QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;txnId&quot;&gt;The unique ID of the transaction.&lt;/param&gt;
        /// &lt;param name=&quot;statementResult&quot;&gt;The result of the statement execution.&lt;/param&gt;
        internal BaseIonEnumerator(Session session, string txnId, ExecuteStatementResult statementResult)
        {
            this.session = session;
            this.txnId = txnId;
            this.currentEnumerator = statementResult.FirstPage.Values.GetEnumerator();
            this.nextPageToken = statementResult.FirstPage.NextPageToken;

            if (statementResult.ConsumedIOs != null)
            {
                this.readIOs = statementResult.ConsumedIOs.ReadIOs;
                this.writeIOs = statementResult.ConsumedIOs.WriteIOs;
            }

            if (statementResult.TimingInformation != null)
            {
                this.processingTimeMilliseconds = statementResult.TimingInformation.ProcessingTimeMilliseconds;
            }
        }

        /// &lt;summary&gt;
        /// Gets current IIonValue.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;The current IIonValue.&lt;/returns&gt;
        public IIonValue Current
        {
            get
            {
                return IonLoader.Load(this.currentEnumerator.Current.IonBinary).GetElementAt(0);
            }
        }

        /// &lt;summary&gt;
        /// Gets the current query statistics for the number of read IO requests.
        /// The statistics are stateful.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;The current IOUsage statistics.&lt;/returns&gt;
        internal IOUsage? GetConsumedIOs()
        {
            if (this.readIOs != null || this.writeIOs != null)
            {
                return new IOUsage(this.readIOs.GetValueOrDefault(), this.writeIOs.GetValueOrDefault());
            }

            return null;
        }

        /// &lt;summary&gt;
        /// Gets the current query statistics for server-side processing time. The statistics are stateful.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;The current TimingInformation statistics.&lt;/returns&gt;
        internal TimingInformation? GetTimingInformation()
        {
            return this.processingTimeMilliseconds == null ? null :
                new TimingInformation(this.processingTimeMilliseconds.Value);
        }

        /// &lt;summary&gt;
        /// Update the metrics.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;pageResult&quot;&gt;The result of a fetch page command.&lt;/param&gt;
        private protected void UpdateMetrics(FetchPageResult pageResult)
        {
            if (pageResult.ConsumedIOs != null)
            {
                this.readIOs = this.readIOs == null ?
                    pageResult.ConsumedIOs.ReadIOs : this.readIOs + pageResult.ConsumedIOs.ReadIOs;
                this.writeIOs = this.writeIOs == null ?
                    pageResult.ConsumedIOs.WriteIOs : this.writeIOs + pageResult.ConsumedIOs.WriteIOs;
            }

            if (pageResult.TimingInformation != null)
            {
                this.processingTimeMilliseconds = this.processingTimeMilliseconds == null ?
                    pageResult.TimingInformation.ProcessingTimeMilliseconds :
                    this.processingTimeMilliseconds + pageResult.TimingInformation.ProcessingTimeMilliseconds;
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,48,1],[33,9,33,49,1],[34,9,34,67,1],[36,9,36,73,1],[45,9,45,106,1],[46,9,46,10,1],[47,13,47,36,1],[48,13,48,32,1],[49,13,49,87,1],[50,13,50,74,1],[52,13,52,53,1],[53,13,53,14,1],[54,17,54,68,1],[55,17,55,70,1],[56,13,56,14,1],[58,13,58,59,1],[59,13,59,14,1],[60,17,60,112,1],[61,13,61,14,1],[62,9,62,10,1],[72,13,72,14,1],[73,17,73,97,1],[74,13,74,14,1],[84,9,84,10,1],[85,13,85,63,1],[86,13,86,14,1],[87,17,87,105,1],[90,13,90,25,1],[91,9,91,10,1],[99,9,99,10,1],[100,13,101,78,1],[102,9,102,10,1],[110,9,110,10,1],[111,13,111,48,1],[112,13,112,14,1],[113,17,114,100,1],[115,17,116,103,1],[117,13,117,14,1],[119,13,119,54,1],[120,13,120,14,1],[121,17,123,111,1],[124,13,124,14,1],[125,9,125,10,1]]);
    </script>
  </body>
</html>