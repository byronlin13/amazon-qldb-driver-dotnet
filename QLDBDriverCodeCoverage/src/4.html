<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Repos\amazon-qldb-driver-dotnet\Amazon.QLDB.Driver\driver\AsyncQldbDriver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

namespace Amazon.QLDB.Driver
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading;
    using System.Threading.Tasks;
    using Amazon.QLDBSession;
    using Microsoft.Extensions.Logging;

    /// &lt;summary&gt;
    /// &lt;para&gt;Represents a factory for accessing a specific ledger within QLDB. This class or
    /// &lt;see cref=&quot;QldbDriver&quot;/&gt; should be the main entry points to any interaction with QLDB.&lt;/para&gt;
    ///
    /// &lt;para&gt;
    /// This factory pools sessions and attempts to return unused but available sessions when getting new sessions.
    /// The pool does not remove stale sessions until a new session is retrieved. The default pool size is the maximum
    /// amount of connections the session client allows set in the &lt;see cref=&quot;ClientConfig&quot;/&gt;. &lt;see cref=&quot;Dispose&quot;/&gt;
    /// should be called when this factory is no longer needed in order to clean up resources, ending all sessions in
    /// the pool.
    /// &lt;/para&gt;
    /// &lt;/summary&gt;
    public class AsyncQldbDriver : IAsyncQldbDriver
    {
        private readonly QldbDriverBase&lt;AsyncQldbSession&gt; driverBase;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;AsyncQldbDriver&quot;/&gt; class.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;ledgerName&quot;&gt;The ledger to create sessions to.&lt;/param&gt;
        /// &lt;param name=&quot;sessionClient&quot;&gt;AWS SDK session client for QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;maxConcurrentTransactions&quot;&gt;The maximum number of concurrent transactions.&lt;/param&gt;
        /// &lt;param name=&quot;logger&quot;&gt;The logger to use.&lt;/param&gt;
        internal AsyncQldbDriver(
            string ledgerName,
            IAmazonQLDBSession sessionClient,
            int maxConcurrentTransactions,
            ILogger logger)
        {
            this.driverBase =
                new QldbDriverBase&lt;AsyncQldbSession&gt;(ledgerName, sessionClient, maxConcurrentTransactions, logger);
        }

        /// &lt;summary&gt;
        /// Retrieve a builder object for creating a &lt;see cref=&quot;AsyncQldbDriver&quot;/&gt;.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;The builder object for creating a &lt;see cref=&quot;AsyncQldbDriver&quot;/&gt;.&lt;/returns&gt;.
        public static AsyncQldbDriverBuilder Builder()
        {
            return new AsyncQldbDriverBuilder();
        }

        /// &lt;summary&gt;
        /// Close this driver and end all sessions in the current pool. No-op if already closed.
        /// &lt;/summary&gt;
        public void Dispose()
        {
            this.driverBase.Dispose();
        }

        /// &lt;inheritdoc/&gt;
        public async Task Execute(
            Func&lt;AsyncTransactionExecutor, Task&gt; action,
            CancellationToken cancellationToken = default)
        {
            await this.Execute(action, QldbDriverBase&lt;AsyncQldbSession&gt;.DefaultRetryPolicy, cancellationToken);
        }

        /// &lt;inheritdoc/&gt;
        public async Task Execute(
            Func&lt;AsyncTransactionExecutor, Task&gt; action,
            RetryPolicy retryPolicy,
            CancellationToken cancellationToken = default)
        {
            await this.Execute(
                async txn =&gt;
                {
                    await action.Invoke(txn);
                    return false;
                },
                retryPolicy,
                cancellationToken);
        }

        /// &lt;inheritdoc/&gt;
        public async Task&lt;T&gt; Execute&lt;T&gt;(
            Func&lt;AsyncTransactionExecutor, Task&lt;T&gt;&gt; func, CancellationToken cancellationToken = default)
        {
            return await this.Execute&lt;T&gt;(func, QldbDriverBase&lt;AsyncQldbSession&gt;.DefaultRetryPolicy, cancellationToken);
        }

        /// &lt;inheritdoc/&gt;
        public async Task&lt;T&gt; Execute&lt;T&gt;(
            Func&lt;AsyncTransactionExecutor, Task&lt;T&gt;&gt; func,
            RetryPolicy retryPolicy,
            CancellationToken cancellationToken = default)
        {
            this.driverBase.ThrowIfClosed();

            bool replaceDeadSession = false;
            for (int retryAttempt = 1; true; retryAttempt++)
            {
                AsyncQldbSession session = null;
                try
                {
                    if (replaceDeadSession)
                    {
                        session = await this.StartNewSession(cancellationToken);
                    }
                    else
                    {
                        session = await this.GetSession(cancellationToken);
                    }

                    T returnedValue = await session.Execute(func, cancellationToken);
                    this.driverBase.ReleaseSession(session);
                    return returnedValue;
                }
                catch (QldbTransactionException qte)
                {
                    replaceDeadSession = await this.driverBase.GetShouldReplaceDeadSessionOrThrowIfNoRetryAsync(
                        qte,
                        session,
                        retryAttempt,
                        retryPolicy,
                        cancellationToken);
                }
            }
        }

        /// &lt;inheritdoc/&gt;
        public async Task&lt;IEnumerable&lt;string&gt;&gt; ListTableNames(CancellationToken cancellationToken = default)
        {
            IAsyncResult result = await this.Execute(
                async txn =&gt; await txn.Execute(QldbDriverBase&lt;AsyncQldbSession&gt;.TableNameQuery), cancellationToken);

            return (await result.ToListAsync(cancellationToken)).Select(i =&gt; i.StringValue);
        }

        internal async Task&lt;AsyncQldbSession&gt; GetSession(CancellationToken token)
        {
            return this.driverBase.GetSessionFromPool() ?? await this.StartNewSession(token);
        }

        private async Task&lt;AsyncQldbSession&gt; StartNewSession(CancellationToken token)
        {
            try
            {
                Session session = await Session.StartSessionAsync(
                    this.driverBase.LedgerName,
                    this.driverBase.SessionClient,
                    this.driverBase.Logger,
                    token);
                this.driverBase.Logger.LogDebug(&quot;Creating new pooled session with ID {}.&quot;, session.SessionId);
                return new AsyncQldbSession(session, this.driverBase.Logger);
            }
            catch (OperationCanceledException oce)
            {
                throw new QldbTransactionException(QldbTransactionException.DefaultTransactionId, false, oce);
            }
            catch (Exception e)
            {
                throw new RetriableException(QldbTransactionException.DefaultTransactionId, false, e);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[48,9,52,28,1],[53,9,53,10,1],[54,13,55,116,1],[56,9,56,10,1],[64,9,64,10,1],[65,13,65,49,1],[66,9,66,10,1],[72,9,72,10,1],[73,13,73,39,1],[74,9,74,10,1],[80,9,80,10,1],[81,13,81,112,1],[82,9,82,10,1],[89,9,89,10,1],[90,13,92,17,1],[92,17,92,18,1],[92,18,93,21,1],[93,21,93,46,1],[93,46,94,21,1],[94,21,94,34,1],[94,34,95,17,1],[95,17,95,18,1],[95,18,97,36,1],[98,9,98,10,1],[103,9,103,10,1],[104,13,104,120,1],[105,9,105,10,1],[112,9,112,10,1],[113,13,113,45,1],[115,13,115,45,1],[116,18,116,38,1],[116,40,116,44,1],[116,46,116,60,1],[117,13,117,14,1],[118,17,118,49,1],[120,17,120,18,1],[121,21,121,44,1],[122,21,122,22,1],[123,25,123,81,1],[124,21,124,22,1],[126,21,126,22,1],[127,25,127,76,1],[128,21,128,22,1],[130,21,130,86,1],[131,21,131,61,1],[132,21,132,42,1],[134,17,134,53,1],[135,17,135,18,1],[136,21,141,44,1],[142,17,142,18,1],[143,13,143,14,1],[144,9,144,10,1],[148,9,148,10,1],[149,13,150,30,1],[150,30,150,96,1],[150,96,150,117,1],[152,13,152,78,1],[152,78,152,91,1],[152,91,152,93,1],[153,9,153,10,1],[156,9,156,10,1],[157,13,157,94,1],[158,9,158,10,1],[161,9,161,10,1],[163,13,163,14,1],[164,17,168,28,1],[169,17,169,111,1],[170,17,170,78,1],[172,13,172,51,0],[173,13,173,14,0],[174,17,174,111,0],[176,13,176,32,1],[177,13,177,14,1],[178,17,178,103,1],[180,9,180,10,1]]);
    </script>
  </body>
</html>