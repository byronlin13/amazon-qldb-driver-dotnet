<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Repos\amazon-qldb-driver-dotnet\Amazon.QLDB.Driver\transaction\AsyncTransaction.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

namespace Amazon.QLDB.Driver
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;
    using System.Threading;
    using System.Threading.Tasks;
    using Amazon.IonDotnet.Tree;
    using Amazon.QLDBSession.Model;
    using Amazon.Runtime;
    using Microsoft.Extensions.Logging;

    /// &lt;summary&gt;
    /// Implementation of a QLDB transaction. Any unexpected errors that occur when calling methods in this class should
    /// not be retried, as the state of the transaction is now ambiguous. When an OCC conflict occurs, the transaction
    /// is closed.
    /// &lt;/summary&gt;
    internal class AsyncTransaction : BaseTransaction, IDisposable
    {
        private readonly CancellationToken cancellationToken;
        private readonly SemaphoreSlim hashLock;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;AsyncTransaction&quot;/&gt; class.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;session&quot;&gt;The parent session that represents the communication channel to QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;txnId&quot;&gt;Transaction identifier.&lt;/param&gt;
        /// &lt;param name=&quot;logger&quot;&gt;Logger to be used by this.&lt;/param&gt;
        /// &lt;param name=&quot;token&quot;&gt;Propagates notification that operations should be canceled.&lt;/param&gt;
        internal AsyncTransaction(Session session, string txnId, ILogger logger, CancellationToken token)
            : base(session, txnId, logger)
        {
            this.cancellationToken = token;
            this.hashLock = new SemaphoreSlim(1, 1);
        }

        public void Dispose()
        {
            this.hashLock.Dispose();
        }

        /// &lt;summary&gt;
        /// Abort the transaction asynchronously and roll back any changes.
        /// Any open &lt;see cref=&quot;IAsyncResult&quot;/&gt; created by the transaction will be invalidated.
        /// &lt;/summary&gt;
        ///
        /// &lt;returns&gt;A task representing the asynchronous abort operation.&lt;/returns&gt;
        internal virtual async Task Abort()
        {
            await this.session.AbortTransactionAsync(this.cancellationToken);
        }

        /// &lt;summary&gt;
        /// Commit the transaction asynchronously.
        /// &lt;/summary&gt;
        ///
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;
        /// Thrown when Hash returned from QLDB is not equal.
        /// &lt;/exception&gt;
        /// &lt;exception cref=&quot;OccConflictException&quot;&gt;
        /// Thrown if an OCC conflict has been detected within the transaction.
        /// &lt;/exception&gt;
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;
        /// Thrown when there is an error committing this transaction against QLDB.
        /// &lt;/exception
        ///
        /// &lt;returns&gt;A task representing the asynchronous commit operation.&lt;/returns&gt;
        internal async Task Commit()
        {
            await this.hashLock.WaitAsync(this.cancellationToken);
            try
            {
                byte[] hashBytes = this.qldbHash.Hash;
                MemoryStream commitDigest = (await this.session.CommitTransactionAsync(
                        this.txnId,
                        new MemoryStream(hashBytes),
                        this.cancellationToken)).CommitDigest;
                if (!hashBytes.SequenceEqual(commitDigest.ToArray()))
                {
                    throw new InvalidOperationException(ExceptionMessages.TransactionDigestMismatch);
                }
            }
            finally
            {
                this.hashLock.Release();
            }
        }

        /// &lt;summary&gt;
        /// Execute the statement asynchronously using the specified parameters against QLDB and retrieve the result.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;statement&quot;&gt;The PartiQL statement to be executed against QLDB.&lt;/param&gt;
        ///
        /// &lt;returns&gt;Result from executed statement.&lt;/returns&gt;
        ///
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;Thrown when there is an error executing against QLDB.&lt;/exception&gt;
        internal virtual async Task&lt;IAsyncResult&gt; Execute(string statement)
        {
            return await this.Execute(statement, new List&lt;IIonValue&gt;());
        }

        /// &lt;summary&gt;
        /// Execute the statement against QLDB and retrieve the result.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;statement&quot;&gt;The PartiQL statement to be executed against QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;parameters&quot;&gt;Parameters to execute.&lt;/param&gt;
        ///
        /// &lt;returns&gt;Result from executed statement.&lt;/returns&gt;
        ///
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;Thrown when there is an error executing against QLDB.&lt;/exception&gt;
        internal virtual async Task&lt;IAsyncResult&gt; Execute(string statement, List&lt;IIonValue&gt; parameters)
        {
            ValidationUtils.AssertStringNotEmpty(statement, &quot;statement&quot;);

            parameters ??= new List&lt;IIonValue&gt;();

            await this.hashLock.WaitAsync(this.cancellationToken);
            try
            {
                this.qldbHash = Dot(this.qldbHash, statement, parameters);
                ExecuteStatementResult executeStatementResult = await this.session.ExecuteStatementAsync(
                    this.txnId, statement, parameters, this.cancellationToken);
                return new AsyncResult(this.session, this.txnId, executeStatementResult, this.cancellationToken);
            }
            finally
            {
                this.hashLock.Release();
            }
        }

        /// &lt;summary&gt;
        /// Execute the statement using the specified parameters against QLDB and retrieve the result.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;statement&quot;&gt;The PartiQL statement to be executed against QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;parameters&quot;&gt;Parameters to execute.&lt;/param&gt;
        ///
        /// &lt;returns&gt;Result from executed statement.&lt;/returns&gt;
        ///
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;Thrown when there is an error executing against QLDB.&lt;/exception&gt;
        internal virtual async Task&lt;IAsyncResult&gt; Execute(string statement, params IIonValue[] parameters)
        {
            return await this.Execute(statement, new List&lt;IIonValue&gt;(parameters));
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[46,15,46,43,1],[47,9,47,10,1],[48,13,48,44,1],[49,13,49,53,1],[50,9,50,10,1],[53,9,53,10,1],[54,13,54,37,1],[55,9,55,10,1],[64,9,64,10,1],[65,13,65,78,1],[66,9,66,10,1],[84,9,84,10,1],[85,13,85,67,1],[87,13,87,14,1],[88,17,88,55,1],[89,17,92,63,1],[93,17,93,70,1],[94,17,94,18,1],[95,21,95,102,1],[97,13,97,14,1],[99,13,99,14,1],[100,17,100,41,1],[101,13,101,14,1],[102,9,102,10,1],[114,9,114,10,1],[115,13,115,73,1],[116,9,116,10,1],[129,9,129,10,1],[130,13,130,74,1],[132,13,132,50,1],[134,13,134,67,1],[136,13,136,14,1],[137,17,137,75,1],[138,17,139,80,1],[140,17,140,114,1],[143,13,143,14,1],[144,17,144,41,1],[145,13,145,14,1],[146,9,146,10,1],[159,9,159,10,0],[160,13,160,83,0],[161,9,161,10,0]]);
    </script>
  </body>
</html>