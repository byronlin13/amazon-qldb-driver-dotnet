<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Repos\amazon-qldb-driver-dotnet\Amazon.QLDB.Driver\transaction\Transaction.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

namespace Amazon.QLDB.Driver
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;
    using Amazon.IonDotnet.Tree;
    using Amazon.QLDBSession.Model;
    using Amazon.Runtime;
    using Microsoft.Extensions.Logging;

    /// &lt;summary&gt;
    /// Implementation of a QLDB transaction. Any unexpected errors that occur when calling methods in this class should
    /// not be retried, as the state of the transaction is now ambiguous. When an OCC conflict occurs, the transaction
    /// is closed.
    /// &lt;/summary&gt;
    internal class Transaction : BaseTransaction
    {
        private readonly object hashLock = new object();

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;Transaction&quot;/&gt; class.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;session&quot;&gt;The parent session that represents the communication channel to QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;txnId&quot;&gt;Transaction identifier.&lt;/param&gt;
        /// &lt;param name=&quot;logger&quot;&gt;Logger to be used by this.&lt;/param&gt;
        internal Transaction(Session session, string txnId, ILogger logger)
            : base(session, txnId, logger)
        {
        }

        /// &lt;summary&gt;
        /// Abort the transaction and roll back any changes.
        /// &lt;/summary&gt;
        internal virtual void Abort()
        {
            this.session.AbortTransaction();
        }

        /// &lt;summary&gt;
        /// Commit the transaction.
        /// &lt;/summary&gt;
        ///
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;
        /// Thrown when Hash returned from QLDB is not equal.
        /// &lt;/exception&gt;
        /// &lt;exception cref=&quot;OccConflictException&quot;&gt;
        /// Thrown if an OCC conflict has been detected within the transaction.
        /// &lt;/exception&gt;
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;
        /// Thrown when there is an error committing this transaction against QLDB.
        /// &lt;/exception&gt;
        internal void Commit()
        {
            // Prevent race condition between Commit and Executes, making them synchronous to ensure hash validity.
            lock (this.hashLock)
            {
                byte[] hashBytes = this.qldbHash.Hash;
                MemoryStream commitDigest = this.session.CommitTransaction(this.txnId, new MemoryStream(hashBytes))
                    .CommitDigest;
                if (!hashBytes.SequenceEqual(commitDigest.ToArray()))
                {
                    throw new InvalidOperationException(ExceptionMessages.TransactionDigestMismatch);
                }
            }
        }

        /// &lt;summary&gt;
        /// Execute the statement using the specified parameters against QLDB and retrieve the result.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;statement&quot;&gt;The PartiQL statement to be executed against QLDB.&lt;/param&gt;
        ///
        /// &lt;returns&gt;Result from executed statement.&lt;/returns&gt;
        ///
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;Thrown when there is an error executing against QLDB.&lt;/exception&gt;
        internal virtual IResult Execute(string statement)
        {
            return this.Execute(statement, new List&lt;IIonValue&gt;());
        }

        /// &lt;summary&gt;
        /// Execute the statement against QLDB and retrieve the result.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;statement&quot;&gt;The PartiQL statement to be executed against QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;parameters&quot;&gt;Parameters to execute.&lt;/param&gt;
        ///
        /// &lt;returns&gt;Result from executed statement.&lt;/returns&gt;
        ///
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;Thrown when there is an error executing against QLDB.&lt;/exception&gt;
        internal virtual IResult Execute(string statement, List&lt;IIonValue&gt; parameters)
        {
            ValidationUtils.AssertStringNotEmpty(statement, &quot;statement&quot;);

            parameters ??= new List&lt;IIonValue&gt;();

            // Prevent race condition between Commit and Executes, making them synchronous to ensure hash validity.
            lock (this.hashLock)
            {
                this.qldbHash = Dot(this.qldbHash, statement, parameters);
                ExecuteStatementResult executeStatementResult = this.session.ExecuteStatement(
                    this.txnId, statement, parameters);
                return new Result(this.session, this.txnId, executeStatementResult);
            }
        }

        /// &lt;summary&gt;
        /// Execute the statement using the specified parameters against QLDB and retrieve the result.
        /// &lt;/summary&gt;
        ///
        /// &lt;param name=&quot;statement&quot;&gt;The PartiQL statement to be executed against QLDB.&lt;/param&gt;
        /// &lt;param name=&quot;parameters&quot;&gt;Parameters to execute.&lt;/param&gt;
        ///
        /// &lt;returns&gt;Result from executed statement.&lt;/returns&gt;
        ///
        /// &lt;exception cref=&quot;AmazonServiceException&quot;&gt;Thrown when there is an error executing against QLDB.&lt;/exception&gt;
        internal virtual IResult Execute(string statement, params IIonValue[] parameters)
        {
            return this.Execute(statement, new List&lt;IIonValue&gt;(parameters));
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,57,1],[42,15,42,43,1],[43,9,43,10,1],[44,9,44,10,1],[50,9,50,10,1],[51,13,51,45,1],[52,9,52,10,1],[68,9,68,10,1],[70,13,70,33,1],[71,13,71,14,1],[72,17,72,55,1],[73,17,74,35,1],[75,17,75,70,1],[76,17,76,18,1],[77,21,77,102,1],[79,13,79,14,1],[80,9,80,10,1],[92,9,92,10,1],[93,13,93,67,1],[94,9,94,10,1],[107,9,107,10,1],[108,13,108,74,1],[110,13,110,50,1],[113,13,113,33,1],[114,13,114,14,1],[115,17,115,75,1],[116,17,117,56,1],[118,17,118,85,1],[120,9,120,10,1],[133,9,133,10,0],[134,13,134,77,0],[135,9,135,10,0]]);
    </script>
  </body>
</html>